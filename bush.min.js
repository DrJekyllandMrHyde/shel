/**@license
 *  This file is part of Bush (Browser Unix Shell)
 *  Copyright (C) 2013  Jakub Jankiewicz <http://jcubic.pl>
 *
 *  This program is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
 *
 *  Date: Thu, 20 Feb 2014 16:51:48 +0000
 */var bush={version:"0.1"};$(function(){function t(t,n,r){var i=e.green(t+"&#64;"+n),s=e.grey(t==="root"?"# ":"$ ");return i+e.grey(":")+e.blue(r)+s}var e=$.omap({blue:"#55f",green:"#4d4",grey:"#999"},function(e,t){return function(e){return"[[;"+t+";]"+e+"]"}}),n;rpc({url:"",error:function(e){var t;e.error?t=e.error.message+"\n["+e.error.at+"] "+e.error.line:t=e.message||e;var r=$.terminal.active();r?(r.resume(),r.error(t)):alert(t),n&&n(null,!0)}})(function(e){e.installed()(function(r){function i(){var e=bush.version.match(/\{{2}VERSION\}{2}/)?"":" v. "+bush.version,t=[" _               _","| |__  _   _ ___| |__","| '_ \\| | | / __| '_ \\","| |_) | |_| \\__ \\ | | |","|_.__/ \\__,_|___/_| |_|","[[b;#fff;]Browser Unix Shell"+e+"]","Today is: "+(new Date).toUTCString(),""].join("\n");return t}function c(){if(location.hash!=""){var e;try{e=$.parseJSON(location.hash.replace(/^#/,""))}catch(t){}if(e)try{$.each(e,function(e,t){l.exec(t,t.match(/^ /))})}catch(t){l.error("Error while exec with command "+$.terminal.escape_brackets(command))}}}var s,o,u,a={},f=!1,l=$("body").terminal(function(n,i){if(!r)i.error("Invalid command, you need to refresh the page");else{function s(){i.echo("Yet to be implemented")}var a=$.terminal.parseCommand(n);switch(a.name){case"su":i.login(i.settings.login,function(){i.push(function(e){i.echo("[[i;;]"+e+"]")},{prompt:"$ "})});break;case"todo":i.echo(["record terminal keystroke with animation and allow to playback","guess login","drag and drop upload","filesystem API","Option to block access when 3 fail attempts (create file on disk and check if it exist)","less as command and as last command","[[;#fff;]cat] without argument","pick the shell",'#["guess", "guess", "play: xxxx"]'].join("\n"));break;case"rpc":i.push(function(e){var t=$.terminal.parseCommand(e.replace("$TOKEN",i.token()));$.jrpc("",t.name,t.args,function(e){if(e.error)if(e.error.error){var t=e.error.error,n=t.file.replace(u.home,"");i.error(t.message+" in "+n+" at "+t.at),i.error(t.line)}else e.error.message&&i.error(e.error.message);else i.echo(JSON.stringify(e.result))},function(e,t){i.error($.terminal.escape_brackets("[AJAX]: ")+t)})},{name:"rpc",prompt:"rpc> ",completion:Object.keys(e)});break;case"history":i.echo("Should show history");break;case"purge":e.logout(i.token())(function(){i.purge().logout()});break;case"js":i.push(function(e,t){if(e!==undefined&&e!=="")try{var n=window.eval(e);n!==undefined&&t.echo(new String(n))}catch(r){t.error(new String(r))}},{prompt:"[[;#D72424;]js]> ",name:"js"});case"jargon":if(a.args.length==0){var f="This is the Jargon File, a comprehensive compendium of hacker slang illuminating many aspects of hackish tradition, folklore, and humor.\n\nusage: jargon [QUERY]";i.echo(f)}else i.pause(),e.jargon(a.args.join(" "))(function(e){i.echo($.map(e,function(e){var t="[[b;#fff;]"+e.term+"]";return e.abbr&&(t+=" ("+e.abbr.join(", ")+")"),t+"\n"+e.def+"\n"}).join("\n").replace(/\n$/,"")).resume()});break;case"sessions":case"sqlite":case"help":case"python":case"mysql":s();break;case"adduser":(function(){var t,n,r=i.history();r.disable(),i.push(function(s){t?(n=s,i.set_mask(!1).pop(),e.add_user(i.token(),t,n)(function(){r.enable()})):(t=s,i.set_mask(!0).set_prompt("password: "))},{prompt:"name: "})})();break;case"micro":var l=$("#micro").micro({height:$(window).height()}).show();a.args.length>=1&&e.file(i.token(),a.args[0])(function(e){l.micro("set",e)});break;case"vi":s();break;default:i.pause();var c=i.token();e.shell(c,n,o)(function(e){e.output&&i.echo(e.output),o!==e.cwd&&(o=e.cwd),i.resume()})}}},{greetings:r?null:i(),prompt:r?function(e){var n;u&&u.server?n=u.server:n="unknown";var r;if(u&&o){var i=$.terminal.escape_regex(u.home);r=o.replace(new RegExp("^"+i),"~")}else r=o;e(t($.terminal.active().login_name(),n,r))}:"> ",onBeforeLogin:function(e){e.echo(i())},outputLimit:200,tabcompletion:!0,onInit:function(t){t.on("click",".jargon",function(){var e="jargon "+$(this).data("text").replace(/\s/g," ");t.exec(e)}).on("click",".exec",function(){t.exec($(this).data("text"))});if(!r){var n={},i=[{name:"password",text:"Type your root password",prompt:"password: ",mask:!0},{name:"server",text:"Type your server name",prompt:"name: "}];t.echo("You are running Bush for the first time. You need to configure it\n"),t.history().disable(),function a(e,r){var s=i[e];s?(t.echo(s.text).push(function(i){t.pop(),s.mask&&t.set_mask(!1),n[s.name]=i,a(e+1,r)},{prompt:s.prompt}),s.mask&&t.set_mask(!0)):r()}(0,function(){t.pause(),e.configure(n)(function(){t.resume().echo("Your instalation is complete now you can refresh the page and login")})})}var s=t.token();s&&(t.pause(),e.valid_token(s)(function(n){n?e.get_settings(t.token())(function(e){u=e,o=u.home,t.resume(),u.purgeOnUnload&&$(window).unload(function(){t.purge()})}):(f=!0,t.logout(),t.resume())}))},completion:function(e,t,n){n(["help"])},onBeforeLogout:function(t){f||e.logout(t.token())(function(){})},login:r?function(t,r,i){n=i,e.login(t,r)(function(e){i(e)})}:!1}).css({overflow:"auto"});c(),$(window).hashchange(c);var h=$(window);h.resize(function(){var e=h.height();l.css("height",e-20),$("#micro").height(e)}).resize()})})});