/*

 This file is part of Bush (acronym for Browser Unix Shell)
 Copyright (C) 2013  Jakub Jankiewicz <http://jcubic.pl>

 This program is free software: you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
 the Free Software Foundation, either version 3 of the License, or
 (at your option) any later version.

 This program is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU General Public License for more details.

 You should have received a copy of the GNU General Public License
 along with this program.  If not, see <http://www.gnu.org/licenses/>.

 Date: Mon, 17 Feb 2014 09:19:07 +0000
*/
var bush={version:"0.1"};
$(function(){var m=$.omap({blue:"#55f",green:"#4d4",grey:"#999"},function(c,f){return function(l){return"[[;"+f+";]"+l+"]"}}),o;rpc({url:"",error:function(c){c=c.error?c.error.message+"\n["+c.error.at+"] "+c.error.line:c.message||c;var f=$.terminal.active();if(f){f.resume();f.error(c)}else alert(c);o&&o(null)}})(function(c){c.installed()(function(f){function l(){return[" _               _\n| |__  _   _ ___| |__\n| '_ \\| | | / __| '_ \\\n| |_) | |_| \\__ \\ | | |\n|_.__/ \\__,_|___/_| |_|","[[b;#fff;]Browser Unix Shell"+
(!bush.version.match(/\{{2}VERSION\}{2}/)?" v. "+bush.version:"")+"]","Today is: "+(new Date).toUTCString(),""].join("\n")}function q(){if(location.hash!=""){var a;try{a=$.parseJSON(location.hash.replace(/^#/,""))}catch(b){}if(a)try{$.each(a,function(j,i){p.exec(i,i.match(/^ /))})}catch(d){p.error("Error while exec with command "+$.terminal.escape_brackets(command))}}}var k,r=false,p=$("body").terminal(function(a,b){if(f){var d=function(){b.echo("Yet to be implemented")},j=$.terminal.parseCommand(a);
switch(j.name){case "su":b.login(b.settings.login,function(){b.push(function(e){b.echo("[[i;;]"+e+"]")},{prompt:"$ "})});break;case "rpc":b.push(function(e){e=$.terminal.parseCommand(e.replace("$TOKEN",b.token()));$.jrpc("",e.name,e.args,function(g){g.error&&g.error.message?b.error(g.error.message):b.echo(JSON.stringify(g.result))},function(g,h){b.error($.terminal.escape_brackets("[AJAX]: ")+h)})},{name:"rpc",prompt:"rpc> "});break;case "history":b.echo("Should show history");break;case "purge":c.logout(b.token())(function(){b.purge().logout()});
break;case "jargon":case "sessions":case "sqlite":case "js":case "help":case "mysql":d();break;case "adduser":(function(){var e,g,h=b.history();h.disable();b.push(function(n){if(e){g=n;b.set_mask(false).pop();c.add_user(b.token(),e,g)(function(){h.enable()})}else{e=n;b.set_mask(true).set_prompt("password: ")}},{prompt:"name: "})})();break;case "micro":var i=$("#micro").micro({height:$(window).height()}).show();j.args.length>=1&&c.file(b.token(),j.args[0])(function(e){i.micro("set",e)});break;case "vi":d();
break;default:b.echo("shell not implemented")}}else b.error("Invalid command, you need to refresh the page")},{greetings:f?null:l(),prompt:f?function(a){var b;b=k&&k.server?k.server:"unknown";var d;d=$.terminal.active().login_name();b=m.green(d+"&#64;"+b);d=m.grey(d==="root"?"# ":"$ ");d=b+m.grey(":")+m.blue("~")+d;a(d)}:"> ",onBeforeLogin:function(a){a.echo(l())},outputLimit:200,tabcompletion:true,onInit:function(a){a.on("click",".jargon",function(){var i="jargon "+$(this).data("text").replace(/\s/g,
" ");a.exec(i)}).on("click",".exec",function(){a.exec($(this).data("text"))});if(!f){var b={},d=[{name:"password",text:"Type your root password",prompt:"password: ",mask:true},{name:"server",text:"Type your server name",prompt:"name: "}];a.echo("You are running Bush for the first time. You need to configure it\n");a.history().disable();(function i(e,g){var h=d[e];if(h){a.echo(h.text).push(function(n){a.pop();h.mask&&a.set_mask(false);b[h.name]=n;i(e+1,g)},{prompt:h.prompt});h.mask&&a.set_mask(true)}else g()})(0,
function(){a.echo(JSON.stringify(b));a.pause();c.configure(b)(function(){a.resume().echo("Your instalation is complete now you can refresh the page and login")})})}var j=a.token();if(j){a.pause();c.valid_token(j)(function(i){if(i)c.get_settings(a.token())(function(e){k=e;a.resume();k.purgeOnUnload&&$(window).unload(function(){a.purge()})});else{r=true;a.logout();a.resume()}})}},completion:function(a,b,d){d(["help"])},onBeforeLogout:function(a){r||c.logout(a.token())(function(){})},login:f?function(a,
b,d){o=d;c.login(a,b)(function(j){d(j)})}:false}).css({overflow:"auto"});q();$(window).hashchange(q);var s=$(window);s.resize(function(){var a=s.height();p.css("height",a-20);$("#micro").height(a)}).resize()})})});
