/*

 This file is part of Bush (acronym for Browser Unix Shell)
 Copyright (C) 2013  Jakub Jankiewicz <http://jcubic.pl>

 This program is free software: you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
 the Free Software Foundation, either version 3 of the License, or
 (at your option) any later version.

 This program is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU General Public License for more details.

 You should have received a copy of the GNU General Public License
 along with this program.  If not, see <http://www.gnu.org/licenses/>.

 Date: Sun, 16 Feb 2014 16:49:56 +0000
*/
var baus={version:"0.1"};
$(function(){var m=$.omap({blue:"#55f",green:"#4d4",grey:"#999"},function(d,f){return function(l){return"[[;"+f+";]"+l+"]"}}),n;rpc({url:"",error:function(d){d=d.error?d.error.message+"\n["+d.error.at+"] "+d.error.line:d.message||d;var f=$.terminal.active();if(f){f.resume();f.error(d)}else alert(d);n&&n(null)}})(function(d){d.installed()(function(f){var l=[" _               _\n| |__  _   _ ___| |__\n| '_ \\| | | / __| '_ \\\n| |_) | |_| \\__ \\ | | |\n|_.__/ \\__,_|___/_| |_|"," [[b;#fff;]Browser Unix Shell 0.1"+
(!baus.version.match(/\{{2}VERSION\}{2}/)?" v. "+baus.version:"")+"]",""].join("\n"),j,q=$("body").terminal(function(b,a){if(f){var c=function(){a.echo("Yet to be implemented")},i=$.terminal.parseCommand(b);switch(i.name){case "help":c();break;case "su":a.login(a.settings.login,function(){a.push(function(e){a.echo("[[i;;]"+e+"]")},{prompt:"$ "})});break;case "rpc":a.push(function(e){e=$.terminal.parseCommand(e.replace("$TOKEN",a.token()));$.jrpc("",e.name,e.args,function(g){g.error&&g.error.message?
a.error(g.error.message):a.echo(JSON.stringify(g.result))},function(g,h){a.error($.terminal.escape_brackets("[AJAX]: ")+h)})},{name:"rpc",prompt:"rpc> "});break;case "sessions":c();break;case "sqlite":c();break;case "mysql":c();break;case "adduser":(function(){var e,g,h=a.history();h.disable();a.push(function(o){if(e){g=o;a.set_mask(false).pop();d.add_user(a.token(),e,g)(function(){h.enable()})}else{e=o;a.set_mask(true).set_prompt("password: ")}},{prompt:"name: "})})();break;case "micro":var k=$("#micro").micro({height:$(window).height()}).show();
i.args.length>=1&&d.file(a.token(),i.args[0])(function(e){k.micro("set",e)});break;case "vi":c()}}else a.error("Invalid command, you need to refresh the page")},{greetings:f?null:l,prompt:f?function(b){var a;a=j&&j.server?j.server:"unknown";var c;c=$.terminal.active().login_name();a=m.green(c+"&#64;"+a);c=m.grey(c==="root"?"# ":"$ ");c=a+m.grey(":")+m.blue("~")+c;b(c)}:"> ",onBeforeLogin:function(b){b.echo(l)},onAfterLogin:function(b){n=null;b.pause();d.get_settings(b.token())(function(a){j=a;b.resume()})},
outputLimit:200,tabcompletion:true,onInit:function(b){if(!f){var a={},c=[{name:"password",text:"Type your root password",prompt:"password: ",mask:true},{name:"server",text:"Type your server name",prompt:"name: "}];b.echo("You are running Bush for the first time. You need to configure it\n");(function k(e,g){var h=c[e];if(h){b.echo(h.text).push(function(o){b.pop();h.mask&&b.set_mask(false);a[h.name]=o;k(e+1,g)},{prompt:h.prompt});h.mask&&b.set_mask(true)}else g()})(0,function(){b.echo(JSON.stringify(a));
b.pause();d.configure(a)(function(){b.resume().echo("Your instalation is complete now you can refresh the page and login")})})}var i=b.token();if(i){b.pause();d.valid_token(i)(function(k){if(k)d.get_settings(b.token())(function(e){j=e;b.resume()});else{b.resume();b.logout()}})}},completion:function(b,a,c){c(["help"])},login:f?function(b,a,c){n=c;d.login(b,a)(function(i){c(i)})}:false}).css({overflow:"auto"}),p=$(window);p.resize(function(){var b=p.height();q.css("height",b-20);$("#micro").height(b)}).resize()})})});
