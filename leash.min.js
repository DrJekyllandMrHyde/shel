/**@license
 *  This file is part of Leash (Browser Shell)
 *  Copyright (c) 2014  Jakub Jankiewicz <http://jcubic.pl>
 *
 *  This program is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
 *
 *  Date: Fri, 21 Mar 2014 14:22:06 +0000
 */var leash={version:"0.1"},init=!1;$(function(){function t(e,n,r){return n>e.length?t(r+e,n,r):e}function n(e,t,n){function r(t,n){var r=$.terminal.escape_brackets("[AJAX] "+n+" server response\n"+t.responseText);e.error(r).resume()}function i(t){typeof t=="string"?e.error(t):(t.message&&e.echo(t.message),t.error.traceback&&e.echo(t.error.traceback))}function s(n,s,o){s===undefined&&(s=[]),e.pause(),$.jrpc(t,n,s,function(t){t.error?i(t.error):t.result&&(o===undefined||o)&&e.echo(t.result.replace(/\n$/,"")),e.resume()},r)}e.pause();var o;$.jrpc(t,"start",[],function(r){r.error?(i(r.error),e.resume()):r.result&&(o=r.result,e.echo("[[b;#F8B612;]Warring: each time you execute a command, python will execute all your previous commands, so watch out on commands that can be executed only once]"),$.jrpc(t,"info",[],function(t){t.error?i(t.error):e.echo(t.result),n({evaluate:function(e){s("evaluate",[o,e])},destroy:function(){s("destroy",[o])}}),e.resume()}))},r)}function r(t,n,r){var i=e.green(t+"&#64;"+n),s=e.grey(t==="root"?"# ":"$ ");return i+e.grey(":")+e.blue(r)+s}var e=$.omap({blue:"#55f",green:"#4d4",grey:"#999"},function(e,t){return function(e){return"[[;"+t+";]"+e+"]"}}),i;rpc({url:"",error:function(e){var t;e.error?(e=e.error,t=e.message+" in "+e.file+"\n["+e.at+"] "+e.line):t=e.message||e;var n=$.terminal.active();n?(n.resume(),n.error(t)):alert(t),i&&i(null,!0)},debug:function(e,t){var n=t=="request"?"->":"<-"}})(function(e){window.service=e,e.installed()(function(t){function s(){var e="";leash.version.match(/\{{2}VERSION\}{2}/)||(e=" v. "+leash.version);var t=["   __   _______   ______ __","  / /  / __/ _ | / __/ // /"," / /__/ _// __ |_\\ \\/ _  /","/____/___/_/ |_/___/_//_/  "+e,"Today is: "+(new Date).toUTCString(),""].join("\n");return t}function h(){if(location.hash){var e;try{e=$.parseJSON(location.hash.replace(/^#/,"")),$.each(e,function(e,t){try{terminal.exec(t)}catch(n){var r=$.terminal.escape_brackets(t),i="Error while exec with command "+r;terminal.error(i).error(n.stack)}})}catch(t){}}}var o,u,a,f={},l=[],c=!1;terminal=$("#shell").terminal(function(i,s){if(!t)s.error("Invalid command, you need to refresh the page");else{function o(){s.echo("Yet to be implemented")}var c={TOKEN:s.token()};function h(e){var t=e;return $.each(c,function(e,n){t=t.replace("$"+e,n)}),t}var p=$.terminal.parseCommand(i),d=s.token();function v(){var t=/\| *less *$/;s.pause(),i.match(t)?(i=i.replace(t,""),e.shell(d,i,u)(function(e){m(e.output),s.resume()})):e.shell(d,i,u)(function(t){if(t.output){var n=/\n(\x1b\[m)?$/;s.echo(t.output.replace(n,""))}u!==t.cwd?(u=t.cwd,e.dir(d,u)(function(e){f=e,s.resume()})):s.resume()})}function m(e){function u(){s.clear(),s.echo(o.slice(i,i+r-1).join("\n"))}function a(){n=s.cols(),r=s.rows(),u()}function f(){s.pop().import_view(t);for(var e=l.length;e--;)if(l[e]==a){l.splice(e,1);break}}var t=s.export_view(),n,r,i=0,o=e.split("\n");l.push(a),a();var c;o.length>r?c=":":c="[[;;;inverted](END)]",s.push($.noop,{keydown:function(e){if(s.get_prompt()!=="/")return e.which==191?s.set_prompt("/"):e.which==81?f():o.length>r&&(e.which===38?i>0&&(--i,u()):e.which===40?i<=o.length-r&&(++i,u()):e.which===34?(i+=r,i>o.length-r+1&&(i=o.length-r+1),u()):e.which===33&&(i-=r,i<0&&(i=0),u())),!1;var t=s.get_command();if(e.which===8&&t==="")s.set_prompt(c);else if(e.which==13){if(t.length>0){var n=new RegExp(t);for(var a=0;a<o.length;++a)if(n.test(o[a])){i=a,u(),s.set_command("");break}s.set_command(""),s.set_prompt(c)}return!1}},prompt:c})}switch(p.name){case"echo":console.log(p.args);break;case"su":s.push(function(e){s.echo("[[u;#fff;]"+e+"]")},{prompt:"$ ",login:function(e,t,n){e=="demo"&&t=="demo"?n("xxx"):n(null)}});break;case"todo":s.echo(["record terminal keystroke with animation and allow to playback","guess login","drag and drop upload","filesystem API","Option to block access when 3 fail attempts (create file on disk and check if it exist)","[[;#fff;]cat] without argument","pick the shell","timer 1s command","edit history",'#["guess", "guess", "play: xxxx"]'].join("\n"));break;case"timer":break;case"reload":location.reload();break;case"man":s.pause(),e.shell(d,i,"/")(function(e){m(e.output),s.resume()});break;case"less":s.pause(),e.shell(d,"cat "+p.args[0],u)(function(e){m(e.output),s.resume()});break;case"rpc":s.push(function(e){var t=$.terminal.parseCommand(h(e));s.pause(),$.jrpc("",t.name,t.args,function(e){if(e.error)if(e.error.error){var t=e.error.error,n=t.file.replace(a.home,"");s.error(t.message+" in "+n+" at "+t.at),s.error(t.line)}else e.error.message&&s.error(e.error.message);else s.echo(JSON.stringify(e.result));s.resume()},function(e,t,n){s.error("[AJAX]: "+t),s.resume(),t=="Invalid JSON"&&s.error(e.responseText)})},{name:"rpc",prompt:"rpc> ",completion:Object.keys(e)});break;case"history":s.echo(s.history().data().join("\n"));break;case"purge":s.logout().purge();break;case"js":s.push(function(e,t){if(e!==undefined&&e!=="")try{var n=window.eval(e);n!==undefined&&t.echo(new String(n))}catch(r){t.error(new String(r))}},{prompt:"[[;#D72424;]js]> ",name:"js"});break;case"jargon":if(!p.args.length){var g="This is the Jargon File, a comprehensive compendium of hacker slang illuminating many aspects of hackish tradition, folklore, and humor.\n\nusage: jargon [QUERY]";s.echo(g)}else{s.pause();var y=p.args.join(" ").replace(/\s+/g," ");e.jargon(y)(function(e){s.echo($.map(e,function(e){var t="[[b;#fff;]"+e.term+"]";return e.abbr&&(t+=" ("+e.abbr.join(", ")+")"),t+"\n"+e.def+"\n"}).join("\n").replace(/\n$/,"")).resume()})}break;case"sessions":o();break;case"sqlite":o();break;case"mysql":(function(){function h(){function a(e){switch($.type(e)){case"array":s.echo(e.map(function(e){return e.join(" | ")}).join("\n"));break;case"number":s.echo("Query OK, "+e+" row affected")}s.resume()}function f(n){s.pause(),e.mysql_query(d,t,n)(a)}function l(){e.mysql_close(d,t)($.noop)}function h(e){e=$.map(e,function(e){return e[0]}),s.push(f,{prompt:c,onExit:l,completion:n.concat(e)}).resume()}s.pause();var t,c="[[b;#55f;]mysql]> ";e.mysql_connect(d,i,o,u,r)(function(n){t=n,e.mysql_query(d,t,"show tables")(h)})}var t=["ACCESSIBLE","ADD","ALL","ALTER","ANALYZE","AND","AS","ASC","ASENSITIVE","BEFORE","BETWEEN","BIGINT","BINARY","BLOB","BOTH","BY","CALL","CASCADE","CASE","CHANGE","CHAR","CHARACTER","CHECK","COLLATE","COLUMN","CONDITION","CONSTRAINT","CONTINUE","CONVERT","CREATE","CROSS","CURRENT_DATE","CURRENT_TIME","CURRENT_TIMESTAMP","CURRENT_USER","CURSOR","DATABASE","DATABASES","DAY_HOUR","DAY_MICROSECOND","DAY_MINUTE","DAY_SECOND","DEC","DECIMAL","DECLARE","DEFAULT","DELAYED","DELETE","DESC","DESCRIBE","DETERMINISTIC","DISTINCT","DISTINCTROW","DIV","DOUBLE","DROP","DUAL","EACH","ELSE","ELSEIF","ENCLOSED","ESCAPED","EXISTS","EXIT","EXPLAIN","FALSE","FETCH","FLOAT","FLOAT4","FLOAT8","FOR","FORCE","FOREIGN","FROM","FULLTEXT","GRANT","GROUP","HAVING","HIGH_PRIORITY","HOUR_MICROSECOND","HOUR_MINUTE","HOUR_SECOND","IF","IGNORE","IN","INDEX","INFILE","INNER","INOUT","INSENSITIVE","INSERT","INT","INT1","INT2","INT3","INT4","INT8","INTEGER","INTERVAL","INTO","IS","ITERATE","JOIN","KEY","KEYS","KILL","LEADING","LEAVE","LEFT","LIKE","LIMIT","LINEAR","LINES","LOAD","LOCALTIME","LOCALTIMESTAMP","LOCK","LONG","LONGBLOB","LONGTEXT","LOOP","LOW_PRIORITY","MASTER_SSL_VERIFY_SERVER_CERT","MATCH","MEDIUMBLOB","MEDIUMINT","MEDIUMTEXT","MIDDLEINT","MINUTE_MICROSECOND","MINUTE_SECOND","MOD","MODIFIES","NATURAL","NOT","NO_WRITE_TO_BINLOG","NULL","NUMERIC","ON","OPTIMIZE","OPTION","OPTIONALLY","OR","ORDER","OUT","OUTER","OUTFILE","PRECISION","PRIMARY","PROCEDURE","PURGE","RANGE","READ","READS","READ_WRITE","REAL","REFERENCES","REGEXP","RELEASE","RENAME","REPEAT","REPLACE","REQUIRE","RESTRICT","RETURN","REVOKE","RIGHT","RLIKE","SCHEMA","SCHEMAS","SECOND_MICROSECOND","SELECT","SENSITIVE","SEPARATOR","SET","SHOW","SMALLINT","SPATIAL","SPECIFIC","SQL","SQLEXCEPTION","SQLSTATE","SQLWARNING","SQL_BIG_RESULT","SQL_CALC_FOUND_ROWS","SQL_SMALL_RESULT","SSL","STARTING","STRAIGHT_JOIN","TABLE","TERMINATED","THEN","TINYBLOB","TINYINT","TINYTEXT","TO","TRAILING","TRIGGER","TRUE","UNDO","UNION","UNIQUE","UNLOCK","UNSIGNED","UPDATE","USAGE","USE","USING","UTC_DATE","UTC_TIME","UTC_TIMESTAMP","VALUES","VARBINARY","VARCHAR","VARCHARACTER","VARYING","WHEN","WHERE","WHILE","WITH","WRITE","XOR","YEAR_MONTH","ZEROFILL"],n=[];$.each(t,function(e,t){n.push(t),n.push(t.toLowerCase())});var r,i,o,u,a=new optparse.OptionParser([["-h","--host HOST","Host to connect to"],["-u","--username USER","Database user"],["-p","--password PASSWORD","Database password"]]),f=[];for(var l=0;l<p.args.length;++l){var c=p.args[l].match(/^(-[a-z])(.*)/);c?(f.push(c[1]),c[2]?f.push(c[2]):c[1]=="-p"&&f.push("")):f.push(p.args[l])}a.on(0,function(e){r=e}),a.on("host",function(e,t){i=t}),a.on("username",function(e,t){o=t}),a.on("password",function(e,t){u=t}),a.banner="Usage: mysql [Options] database",a.parse(f);if(!r||!o){s.echo(a);return}i=i||"localhost",u?h():(s.history().disable(),s.push(function(e){u=e,s.pop().history().enable(),h()},{prompt:"password: "}).set_mask(!0))})();break;case"help":break;case"python":if(p.args.length){v();return}var b="cgi-bin/python.py?token="+d;n(s,b,function(e){var t="",n="Type help() for interactive help, or help(object) for help about object.";s.push(function(r){if(r.match(/help/))if(r.match(/^help *$/))s.echo(n);else{var i=/help\((.*)\)/;e.evaluate(r.replace(i,"print $1.__doc__"))}else r.match(/: *$/)?(t+=r+"\n",s.set_prompt("... ")):t?r==""?(s.set_prompt(">>> "),e.evaluate(t),t=""):t+=r+"\n":e.evaluate(r)},{name:"python",prompt:">>> ",onExit:function(){e.destroy()}})});break;case"adduser":(function(){var t,n,r=s.history();r.disable(),s.push(function(i){t?(n=i,s.set_mask(!1).pop(),e.add_user(d,t,n)(function(){r.enable()})):(t=i,s.set_mask(!0).set_prompt("password: "))},{prompt:"name: "})})();break;case"micro":var w=$("#micro").micro({height:$(window).height()}).show();p.args.length>=1&&e.shell(d,"cat "+p.args[0],u)(function(e){w.micro("set",e.output)});break;case"vi":o();break;default:v()}}},{greetings:t?null:s(),maskChar:"",prompt:t?function(e){var t;a&&a.server?t=a.server:t="unknown";var n;if(a&&u){var i=$.terminal.escape_regex(a.home);n=u.replace(new RegExp("^"+i),"~")}else n=u;var s=$.terminal.active().login_name();e(r(s,t,n))}:"> ",onBeforeLogin:function(e){e.echo(s())},historyFilter:function(e){return!e.match(/^ /)},outputLimit:500,onResize:function(e){for(var t=l.length;t--;)typeof l[t]=="function"&&l[t](e)},onInit:function(n){n.on("click",".jargon",function(){n.exec("jargon "+$(this).data("text").replace(/\s/g," "))}).on("click",".exec",function(){n.exec($(this).data("text"))}).on("click",".exception a",function(){var e=$(this).attr("href"),t=/(.*):([0-9]+):([0-9]+)$/;m=e.match(t);if(m)return $.get(m[1],function(e){var t=location.href.replace(/[^\/]+$/,""),r=m[1].replace(t,"");n.echo("[[b;white;]"+r+"]");var i=e.split("\n"),s=+m[2]-1;n.echo(i.slice(s-2,s+3).map(function(e,t){return t==2&&(e="[[;#f00;]"+e+"]"),"["+(s+t)+"]: "+e}).join("\n"))},"text"),!1});if(!t){var r={},i=[{name:"root_password",prompt:"root password: ",mask:!0},{name:"server",text:"Type your server name"},{name:"username",text:"Your normal username"},{name:"password",mask:!0}];n.echo("[[;#C78100;]You are running Leash for the first time. You need to configure it]\n"),n.history().disable(),function o(e,t){var s=i[e];s?(s.text&&n.echo("[[b;#fff;]"+s.text+"]"),n.push(function(i){n.pop(),s.mask&&n.set_mask(!1),r[s.name]=i,o(e+1,t)},{prompt:s.prompt||s.name+": "}),s.mask&&n.set_mask(!0)):t()}(0,function(){function i(o,u){if(o.length){var a=o[0],f=o.slice(1),l="Test Shell '"+a+"' ";e.test_shell(s,a)(function(e){e?l+="[[[b;"+t.green+";]PASS]]":l+="[[[b;"+t.red+";]FAIL]]",n.echo(l),e?(n.echo("Using shell "+a),r.shell=a,u()):i(f,u)})}else n.error("Not valid shell found"),n.error("You will not able to use Leash fully")}n.pause();var t=$.terminal.ansi_colors.bold;n.echo("Detect Shell"),e.list_shells(s)(function(t){i(t,function(){e.configure(r)(function(){n.resume(),n.echo("Your instalation is complete now youcan refresh the page and login")})})})})}var s=n.token();s&&(n.pause(),e.valid_token(s)(function(t){t?e.get_settings(s)(function(t){a=t,u=a.home,e.dir(s,u)(function(e){f=e,n.resume()}),a.purgeOnUnload&&$(window).unload(function(){n.purge()})}):(c=!0,n.logout(),n.resume())}))},completion:function(e,t,n){n(["help"])},onBeforeLogout:function(t){c||e.logout(t.token())(function(){})},login:t?function(t,n,r){i=r,this.pause(),e.login(t,n)(function(e){i=null,r(e)})}:!1,name:"leash"}).css({overflow:"auto"});var p=$(window);p.hashchange(h).hashchange().resize(function(){var e=p.height();terminal.height(e-20),$("#micro").height(e)}).resize(),terminal.resize()})})});