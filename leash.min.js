/**@license
 *  This file is part of Leash (Browser Shell)
 *  Copyright (c) 2013-2014 Jakub Jankiewicz <http://jcubic.pl>
 *
 *  This program is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
 *
 *  Date: Wed, 11 Jun 2014 14:57:42 +0000
 */var leash=function(){function n(e,t,r){return t>e.length?n(r+e,t,r):e}function r(){var e=["ACCESSIBLE","ADD","ALL","ALTER","ANALYZE","AND","AS","ASC","ASENSITIVE","BEFORE","BETWEEN","BIGINT","BINARY","BLOB","BOTH","BY","CALL","CASCADE","CASE","CHANGE","CHAR","CHARACTER","CHECK","COLLATE","COLUMN","CONDITION","CONSTRAINT","CONTINUE","CONVERT","CREATE","CROSS","CURRENT_DATE","CURRENT_TIME","CURRENT_TIMESTAMP","CURRENT_USER","CURSOR","DATABASE","DATABASES","DAY_HOUR","DAY_MICROSECOND","DAY_MINUTE","DAY_SECOND","DEC","DECIMAL","DECLARE","DEFAULT","DELAYED","DELETE","DESC","DESCRIBE","DETERMINISTIC","DISTINCT","DISTINCTROW","DIV","DOUBLE","DROP","DUAL","EACH","ELSE","ELSEIF","ENCLOSED","ESCAPED","EXISTS","EXIT","EXPLAIN","FALSE","FETCH","FLOAT","FLOAT4","FLOAT8","FOR","FORCE","FOREIGN","FROM","FULLTEXT","GRANT","GROUP","HAVING","HIGH_PRIORITY","HOUR_MICROSECOND","HOUR_MINUTE","HOUR_SECOND","IF","IGNORE","IN","INDEX","INFILE","INNER","INOUT","INSENSITIVE","INSERT","INT","INT1","INT2","INT3","INT4","INT8","INTEGER","INTERVAL","INTO","IS","ITERATE","JOIN","KEY","KEYS","KILL","LEADING","LEAVE","LEFT","LIKE","LIMIT","LINEAR","LINES","LOAD","LOCALTIME","LOCALTIMESTAMP","LOCK","LONG","LONGBLOB","LONGTEXT","LOOP","LOW_PRIORITY","MASTER_SSL_VERIFY_SERVER_CERT","MATCH","MEDIUMBLOB","MEDIUMINT","MEDIUMTEXT","MIDDLEINT","MINUTE_MICROSECOND","MINUTE_SECOND","MOD","MODIFIES","NATURAL","NOT","NO_WRITE_TO_BINLOG","NULL","NUMERIC","ON","OPTIMIZE","OPTION","OPTIONALLY","OR","ORDER","OUT","OUTER","OUTFILE","PRECISION","PRIMARY","PROCEDURE","PURGE","RANGE","READ","READS","READ_WRITE","REAL","REFERENCES","REGEXP","RELEASE","RENAME","REPEAT","REPLACE","REQUIRE","RESTRICT","RETURN","REVOKE","RIGHT","RLIKE","SCHEMA","SCHEMAS","SECOND_MICROSECOND","SELECT","SENSITIVE","SEPARATOR","SET","SHOW","SMALLINT","SPATIAL","SPECIFIC","SQL","SQLEXCEPTION","SQLSTATE","SQLWARNING","SQL_BIG_RESULT","SQL_CALC_FOUND_ROWS","SQL_SMALL_RESULT","SSL","STARTING","STRAIGHT_JOIN","TABLE","TERMINATED","THEN","TINYBLOB","TINYINT","TINYTEXT","TO","TRAILING","TRIGGER","TRUE","UNDO","UNION","UNIQUE","UNLOCK","UNSIGNED","UPDATE","USAGE","USE","USING","UTC_DATE","UTC_TIME","UTC_TIMESTAMP","VALUES","VARBINARY","VARCHAR","VARCHARACTER","VARYING","WHEN","WHERE","WHILE","WITH","WRITE","XOR","YEAR_MONTH","ZEROFILL"],t=[];return $.each(e,function(e,n){t.push(n),t.push(n.toLowerCase())}),t}function i(e,t,n){function r(t,n){var r=$.terminal.escape_brackets("[AJAX] "+n+" server response\n"+t.responseText);e.error(r).resume()}function i(t){typeof t=="string"?e.error(t):(t.message&&e.echo(t.message),t.error.traceback&&e.echo(t.error.traceback))}function s(n,s,o){s===undefined&&(s=[]),e.pause(),$.jrpc(t,n,s,function(t){t.error?i(t.error):t.result&&(o===undefined||o)&&e.echo(t.result.replace(/\n$/,"")),e.resume()},r)}e.pause();var o;$.jrpc(t,"start",[],function(r){r.error?(i(r.error),e.resume()):r.result&&(o=r.result,e.echo("[[b;#F8B612;]Warring: each time you execute a command, python will execute all your previous commands, so watch out on commands that can be executed only once]"),$.jrpc(t,"info",[],function(t){t.error?i(t.error):e.echo(t.result),n({evaluate:function(e){s("evaluate",[o,e])},destroy:function(){s("destroy",[o])}}),e.resume()}))},r)}function s(t,n,r){var i=e.green(t+"&#64;"+n),s=e.grey(t==="root"?"# ":"$ ");return i+e.grey(":")+e.blue(r)+s}var e=$.omap({blue:"#55f",green:"#4d4",grey:"#999"},function(e,t){return function(e,n){return"[["+(n||"")+";"+t+";]"+e+"]"}}),t=["Copyright (c) 2013-2014 Jakub Jankiewicz <http://jcubic.pl>","","This program is free software: you can redistribute it and/or modify","it under the terms of the GNU General Public License as published by","the Free Software Foundation, either version 3 of the License, or","(at your option) any later version.","","This program is distributed in the hope that it will be useful,","but WITHOUT ANY WARRANTY; without even the implied warranty of","MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the","GNU General Public License for more details.","","You should have received a copy of the GNU General Public License","along with this program.  If not, see <http://www.gnu.org/licenses/>."].map(function(e){return e==""?e:"  "+e}).join("\n");return function(e){var n=new $.Deferred,o;return rpc({url:e||"",error:function(e){var t;e.error?(e=e.error,t=e.message+" in "+e.file+"\n["+e.at+"] "+e.line):t=e.message||e;var n=$.terminal.active();n?(n.resume(),n.error(t)):alert(t),o&&o(null,!0)},debug:function(e,t){var n=t=="request"?"->":"<-"}})(function(e){function h(e){var t=e;return $.each(c,function(e,n){t=t.replace("$"+e,n)}),t}function p(e,t){var n=/(.*):([0-9]+):([0-9]+)$/;m=e.match(n);if(m)return $.get(m[1],function(e){var n=location.href.replace(/[^\/]+$/,""),r=m[1].replace(n,"");t.echo("[[b;white;]"+r+"]");var i=e.split("\n"),s=+m[2]-1;t.echo(i.slice(s-2,s+3).map(function(e,t){return t==2&&(e="[[;#f00;]"+e+"]"),"["+(s+t)+"]: "+e}).join("\n"))},"text"),!1}var u,a,f,l={},c={},v={version:"0.2",date:"Wed, 11 Jun 2014 14:57:42 +0000",banner:function(){var e="";v.version.match(/\{{2}VERSION\}{2}/)||(e=" v. "+v.version);var t="";v.date.match(/\{{2}DATE\}{2}/)||(t="build at: "+v.date);var n=["   __   _______   ______ __","  / /  / __/ _ | / __/ // /"," / /__/ _// __ |_\\ \\/ _  /","/____/___/_/ |_/___/_//_/  "+e];return t&&n.push(t),n.push(""),n.join("\n")},service:e,init:function(e){e.on("click",".jargon",function(){e.exec("jargon "+$(this).data("text").replace(/\s/g," "))}).on("click",".exec",function(){e.exec($(this).data("text"))}).on("click",".exception a",function(){return p($(this).attr("href"),e),!1}),v.installed?v.config(e):v.install(e)},interpreter:function(e,t){if(!v.installed)t.error("Invalid command, you need to refresh the page");else{var n=t.token();c.TOKEN=n;var r=$.terminal.parseCommand(e);v.commands[r.name]?v.commands[r.name](r,n,t):v.shell(e,n,t)}},install:function(t){var n={},r=[{name:"root_password",prompt:"root password: ",mask:!0},{name:"server",text:"Type your server name"},{name:"username",text:"Your normal username"},{name:"password",mask:!0}];t.echo("[[;#C78100;]You are running Leash for the first time. You need to configure it]\n"),t.history().disable(),function i(e,s){var o=r[e];o?(o.text&&t.echo("[[b;#fff;]"+o.text+"]"),t.push(function(r){t.pop(),o.mask&&t.set_mask(!1),n[o.name]=r,i(e+1,s)},{prompt:o.prompt||o.name+": "}),o.mask&&t.set_mask(!0)):s()}(0,function(){function i(s,o){if(s.length){var u=s[0],a=s.slice(1),f="Test Shell '"+u+"' ";e.test_shell(token,u)(function(e){e?f+="[[[b;"+r.green+";]PASS]]":f+="[[[b;"+r.red+";]FAIL]]",t.echo(f),e?(t.echo("Using shell "+u),n.shell=u,o()):i(a,o)})}else t.error("Not valid shell found"),t.error("You will not able to use Leash fully")}t.pause();var r=$.terminal.ansi_colors.bold;t.echo("Detect Shell"),e.list_shells(token)(function(r){i(r,function(){e.configure(n)(function(){t.resume(),t.echo("Your instalation is complete now you can refresh the page and login")})})})})},config:function(t){var n=t.token();n&&(t.pause(),e.valid_token(n)(function(r){r?e.get_settings(n)(function(r){f=r,a=f.home,e.dir(n,a)(function(e){l=e,t.resume()}),f.purgeOnUnload&&$(window).unload(function(){t.purge()})}):(t.set_token(undefined),t.logout(),t.resume())}))},shell:function(t,n,r){var i=/\|\s*less\s*$/;r.pause(),t.match(i)?(t=t.replace(i,""),e.shell(n,t,a)(function(e){v.less(e.output,r),r.resume()})):e.shell(n,t,a)(function(t){if(t.output){var i=/\n(\x1b\[m)?$/;r.echo(t.output.replace(i,""))}a!==t.cwd?(a=t.cwd,e.dir(n,a)(function(e){l=e,r.resume()})):r.resume()})},less:function(e,t){function u(){t.clear(),t.echo(o.slice(s,s+i-1).join("\n"))}function a(){r=t.cols(),i=t.rows(),u()}function f(){t.pop().import_view(n),t.off("resize.less",a)}if(typeof e!="string")return;var n=t.export_view(),r,i,s=0,o=e.split("\n");t.on("resize.less",a),a();var l;o.length>i?l=":":l="[[;;;inverted](END)]",t.push($.noop,{keydown:function(e){if(t.get_prompt()!=="/"){e.which==191?t.set_prompt("/"):e.which==81?f():o.length>i&&(e.which===38?s>0&&(--s,u()):e.which===40?s<=o.length-i&&(++s,u()):e.which===34?(s+=i,s>o.length-i+1&&(s=o.length-i+1),u()):e.which===33&&(s-=i,s<0&&(s=0),u()));if(!e.ctrlKey&&!e.alKey)return!1}else{var n=t.get_command();if(e.which===8&&n==="")t.set_prompt(l);else if(e.which==13){if(n.length>0){var r=new RegExp(n);for(var a=0;a<o.length;++a)if(r.test(o[a])){s=a,u(),t.set_command("");break}t.set_command(""),t.set_prompt(l)}return!1}}},prompt:l})},completion:function(e,t,n){var r=e.get_command();if(r.match(/^\s*[^\s]*\s*$/)||r==""){var i=Object.keys(v.commands);n(i.concat(l.execs||[]).concat(f.executables))}else{var s=$.terminal.parseCommand(r);s.name=="cd"?n(l.dirs||[]):n(l.files||[])}},commands:{help:function(){},copyright:function(e,n,r){r.echo(t)},less:function(t,n,r){var i="cat "+t.args[0];r.pause(),e.shell(n,i,a)(function(e){r.resume(),v.less(e.output,r)})},record:function(e,t,n){e.args[0]=="start"?n.history_state(!0):e.args[0]=="stop"?n.history_state(!1):n.echo("usage:\n	record [stop|start]")},todo:function(e,t,n){n.echo(["record terminal keystroke with animation and allow to playback","guess login","drag and drop upload","filesystem API","Option to block access when 3 fail attempts (create file on disk and check if it exist)","[[;#fff;]cat] without argument","pick the shell","timer 1s command","edit history",'#["guess", "guess", "play: xxxx"]'].join("\n"))},rpc:function(t,n,r){r.push(function(e){var t=$.terminal.parseCommand(h(e));r.pause(),$.jrpc("",t.name,t.args,function(e){if(e.error)if(e.error.error){var t=e.error.error,n=t.file.replace(f.home,"");r.error(t.message+" in "+n+" at "+t.at),r.error(t.line)}else e.error.message&&r.error(e.error.message);else r.echo(JSON.stringify(e.result));r.resume()},function(e,t,n){r.error("[AJAX]: "+t),r.resume(),t=="Invalid JSON"&&r.error(e.responseText)})},{name:"rpc",prompt:"rpc> ",completion:Object.keys(e)})},jargon:function(t,n,r){if(!t.args.length){var i="This is the Jargon File, a comprehensive compendium of hacker slang illuminating many aspects of hackish tradition, folklore, and humor.\n\nusage: jargon [QUERY]";r.echo(i)}else{r.pause();var s=t.args.join(" ").replace(/\s+/g," ");e.jargon(s)(function(e){r.echo($.map(e,function(e){var t="[[b;#fff;]"+e.term+"]";return e.abbr&&(t+=" ("+e.abbr.join(", ")+")"),t+"\n"+e.def+"\n"}).join("\n").replace(/\n$/,"")).resume()})}},man:function(t,n,r){r.pause(),e.shell(n,t.command,"/")(function(e){v.less(e.output,r),r.resume()})},mysql:function(t,n,i){function p(){function f(e){switch($.type(e)){case"array":i.echo(e.map(function(e){return e.join(" | ")}).join("\n"));break;case"number":i.echo("Query OK, "+e+" row affected")}i.resume()}function l(r){i.pause(),e.mysql_query(n,t,r)(f)}function c(){e.mysql_close(n,t)($.noop)}function p(e){e=$.map(e,function(e){return e[0]}),i.push(l,{prompt:h,onExit:c,completion:r().concat(e)}).resume()}i.pause();var t,h="[[b;#55f;]mysql]> ";e.mysql_connect(n,o,u,a,s)(function(r){t=r,e.mysql_query(n,t,"show tables")(p)})}var s,o,u,a,f=new optparse.OptionParser([["-h","--host HOST","Host to connect to"],["-u","--username USER","Database user"],["-p","--password PASSWORD","Database password"]]),l=[];for(var c=0;c<t.args.length;++c){var h=t.args[c].match(/^(-[a-z])(.*)/);h?(l.push(h[1]),h[2]?l.push(h[2]):h[1]=="-p"&&l.push("")):l.push(t.args[c])}f.on(0,function(e){s=e}),f.on("host",function(e,t){o=t}),f.on("username",function(e,t){u=t}),f.on("password",function(e,t){a=t}),f.banner="Usage: mysql [Options] database",f.parse(l);if(!s||!u){i.echo(f);return}o=o||"localhost",a?p():(i.history().disable(),i.push(function(e){a=e,i.pop().history().enable(),p()},{prompt:"password: "}).set_mask(!0))},js:function(e,t,n){n.push(function(e,t){if(e!==undefined&&e!=="")try{var n=window.eval(e);n!==undefined&&t.echo(new String(n))}catch(r){t.error(new String(r))}},{prompt:"[[;#D72424;]js]> ",name:"js"})},python:function(e,t,n){if(e.args.length){v.shell(e.command,t,n);return}var r="cgi-bin/python.py?token="+t;i(n,r,function(e){var t="",r="Type help() for interactive help, or help(object) for help about object.";n.push(function(i){if(i.match(/help/))if(i.match(/^help *$/))n.echo(r);else{var s=/help\((.*)\)/;e.evaluate(i.replace(s,"print $1.__doc__"))}else i.match(/: *$/)?(t+=i+"\n",n.set_prompt("... ")):t?i==""?(n.set_prompt(">>> "),e.evaluate(t),t=""):t+=i+"\n":e.evaluate(i)},{name:"python",prompt:">>> ",onExit:function(){e.destroy()}})})},history:function(e,t,n){n.echo(n.history().data().join("\n"))},su:function(e,t,n){n.echo("testing command"),n.push(function(e){n.echo("[[u;#fff;]"+e+"]")},{prompt:"$ ",login:function(e,t,n){e=="demo"&&t=="demo"?n("xxx"):n(null)}})},adduser:function(t,n,r){var i,s,o=r.history();o.disable(),r.push(function(t){i?(s=t,r.set_mask(!1).pop(),e.add_user(n,i,s)(function(){o.enable()})):(i=t,r.set_mask(!0).set_prompt("password: "))},{prompt:"name: "})},micro:function(t,n,r){var i=$("#micro").micro({height:$(window).height()}).show();if(t.args.length>=1){var s="cat "+t.args[0];e.shell(n,s,a)(function(e){i.micro("set",e.output)})}}}};e.installed()(function(t){v.installed=t,t?(v.greetings=v.banner(),v.prompt=function(e){var t;f&&f.server?t=f.server:t="unknown";var n;if(f&&a){var r=$.terminal.escape_regex(f.home);n=a.replace(new RegExp("^"+r),"~")}else n=a;var i=$.terminal.active().login_name();e(s(i,t,n))},v.login=function(t,n,r){o=r,this.pause(),e.login(t,n)(function(e){o=null,r(e)})}):(v.prompt="> ",v.login=!1,v.greetings=null),n.resolve(v)})}),n.promise()}}();(function(e){e.fn.leash=function(t){if(!e.terminal||!e.fn.terminal)throw new Error("You need to include jQuery terminal to use leash");if(this.data("leash"))return this.data("leash");var n=e.Deferred(),r=this.size(),i=[];return this.each(function(s){var o=e(this);leash().then(function(u){o.data("leash",u);var a={onInit:u.init,maskChar:"",completion:u.completion,linksNoReferer:!0,execHash:!0,historyFilter:/^[^\s]/,onBeforeLogout:function(e){var t=e.token();t&&u.service.logout()(function(){})},prompt:u.prompt,login:u.login,name:"leash",outputLimit:500,greetings:u.greetings};o.terminal(u.interpreter,e.extend(a,t||{})),i.push(u),r-1==s&&n.resolve.apply(n,i)})}),n.promise()}})(jQuery);