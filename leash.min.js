/**@license
 *  This file is part of Leash (Browser Shell)
 *  Copyright (C) 2013  Jakub Jankiewicz <http://jcubic.pl>
 *
 *  This program is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
 *
 *  Date: Wed, 05 Mar 2014 12:07:07 +0000
 */var leash={version:"0.1"},init=!1;$(function(){function t(e,n,r){return n>e.length?t(r+e,n,r):e}function n(e,t,n){function r(t,n){var r=$.terminal.escape_brackets("[AJAX] "+n+" server response\n"+t.responseText);e.error(r).resume()}function i(t){typeof t=="string"?e.error(t):(t.message&&e.echo(t.message),t.error.traceback&&e.echo(t.error.traceback))}function s(n,s,o){s===undefined&&(s=[]),e.pause(),$.jrpc(t,n,s,function(t){t.error?i(t.error):t.result&&(o===undefined||o)&&e.echo(t.result.replace(/\n$/,"")),e.resume()},r)}e.pause();var o;$.jrpc(t,"start",[],function(r){r.error?(i(r.error),e.resume()):r.result&&(o=r.result,e.echo("[[b;#F8B612;]Warring: each time you execute a command, python will execute all your previous commands, so watch out on commands that can be exeucted only once]"),$.jrpc(t,"info",[],function(t){t.error?i(t.error):e.echo(t.result),n({evaluate:function(e){s("evaluate",[o,e])},destroy:function(){s("destroy",[o])}}),e.resume()}))},r)}function r(t,n,r){var i=e.green(t+"&#64;"+n),s=e.grey(t==="root"?"# ":"$ ");return i+e.grey(":")+e.blue(r)+s}var e=$.omap({blue:"#55f",green:"#4d4",grey:"#999"},function(e,t){return function(e){return"[[;"+t+";]"+e+"]"}}),i;rpc({url:"",error:function(e){var t;e.error?t=e.error.message+"\n["+e.error.at+"] "+e.error.line:t=e.message||e;var n=$.terminal.active();n?(n.resume(),n.error(t)):alert(t),i&&i(null,!0)},debug:function(e,t){var n=t=="request"?"->":"<-"}})(function(e){window.service=e,e.installed()(function(t){function s(){var e="";leash.version.match(/\{{2}VERSION\}{2}/)||(e=" v. "+leash.version);var t=["   __   _______   ______ __","  / /  / __/ _ | / __/ // /"," / /__/ _// __ |_\\ \\/ _  / ","/____/___/_/ |_/___/_//_/  ","[[b;#fff;]Browser Shell"+e+"]","Today is: "+(new Date).toUTCString(),""].join("\n");return t}function c(){if(location.hash){var e;try{e=$.parseJSON(location.hash.replace(/^#/,"")),$.each(e,function(e,t){try{terminal.exec(t)}catch(n){var r=$.terminal.escape_brackets(t),i="Error while exec with command "+r;terminal.error(i).error(n.stack)}})}catch(t){}}}var o,u,a,f={},l=!1;window.terminal=$("#shell").terminal(function(i,s){if(!t)s.error("Invalid command, you need to refresh the page");else{function o(){s.echo("Yet to be implemented")}var f=$.terminal.parseCommand(i);function l(){s.pause();var t=s.token();e.shell(t,i,u)(function(e){e.output&&s.echo(e.output),u!==e.cwd&&(u=e.cwd),s.resume()})}switch(f.name){case"su":s.push(function(e){s.echo("[[u;#fff;]"+e+"]")},{prompt:"$ "}).login(function(e,t,n){e=="demo"&&t=="demo"?n("xxx"):(n(null),s.pop())});break;case"todo":s.echo(["record terminal keystroke with animation and allow to playback","guess login","drag and drop upload","filesystem API","Option to block access when 3 fail attempts (create file on disk and check if it exist)","less as command and as last command","[[;#fff;]cat] without argument","pick the shell","timer 1s command",'#["guess", "guess", "play: xxxx"]'].join("\n"));break;case"timer":break;case"reload":location.reload();break;case"rpc":s.push(function(e){var t=$.terminal.parseCommand(e.replace("$TOKEN",s.token()));s.pause(),$.jrpc("",t.name,t.args,function(e){if(e.error)if(e.error.error){var t=e.error.error,n=t.file.replace(a.home,"");s.error(t.message+" in "+n+" at "+t.at),s.error(t.line)}else e.error.message&&s.error(e.error.message);else s.echo(JSON.stringify(e.result));s.resume()},function(e,t){s.error($.terminal.escape_brackets("[AJAX]: ")+t)})},{name:"rpc",prompt:"rpc> ",completion:Object.keys(e)});break;case"history":s.echo(s.history().data().join("\n"));break;case"purge":s.logout().purge();break;case"js":s.push(function(e,t){if(e!==undefined&&e!=="")try{var n=window.eval(e);n!==undefined&&t.echo(new String(n))}catch(r){t.error(new String(r))}},{prompt:"[[;#D72424;]js]> ",name:"js"});break;case"jargon":if(!f.args.length){var c="This is the Jargon File, a comprehensive compendium of hacker slang illuminating many aspects of hackish tradition, folklore, and humor.\n\nusage: jargon [QUERY]";s.echo(c)}else{s.pause();var h=f.args.join(" ").replace(/\s+/g," ");e.jargon(h)(function(e){s.echo($.map(e,function(e){var t="[[b;#fff;]"+e.term+"]";return e.abbr&&(t+=" ("+e.abbr.join(", ")+")"),t+"\n"+e.def+"\n"}).join("\n").replace(/\n$/,"")).resume()})}break;case"sessions":o();break;case"sqlite":o();break;case"mysql":(function(){function c(){function u(e){s.echo(e.map(function(e){return e.join(" | ")}).join("\n")),s.resume()}function a(t){s.pause(),e.mysql_query(s.token(),o,t)(u)}function f(){e.mysql_close(s.token(),o)($.noop)}s.pause();var o,l="[[b;#55f;]mysql]> ";e.mysql_connect(s.token(),n,r,i,t)(function(e){o=e,s.push(a,{prompt:l,onExit:f}).resume()})}var t,n,r,i,o=new optparse.OptionParser([["-h","--host HOST","Host to connect to"],["-u","--username USER","Database user"],["-p","--password PASSWORD","Database password"]]),u=[];for(var a=0;a<f.args.length;++a){var l=f.args[a].match(/^(-[a-z])(.*)/);l?(u.push(l[1]),l[2]?u.push(l[2]):l[1]=="-p"&&u.push("")):u.push(f.args[a])}o.on(0,function(e){t=e}),o.on("host",function(e,t){n=t}),o.on("username",function(e,t){r=t}),o.on("password",function(e,t){i=t}),o.banner="Usage: mysql [Options] database",o.parse(u);if(!t||!r){s.echo(o);return}n=n||"localhost",i?c():(s.history().disable(),s.push(function(e){i=e,s.pop().history().enable(),c()},{prompt:"password: "}).set_mask(!0))})();break;case"help":break;case"python":if(f.args.length){l();return}var p="cgi-bin/python.py?token="+s.token();n(s,p,function(e){var t="",n="Type help() for interactive help, or help(object) for help about object.";s.push(function(r){if(r.match(/help/))if(r.match(/^help *$/))s.echo(n);else{var i=/help\((.*)\)/;e.evaluate(r.replace(i,"print $1.__doc__"))}else r.match(/: *$/)?(t+=r+"\n",s.set_prompt("... ")):t?r==""?(s.set_prompt(">>> "),e.evaluate(t),t=""):t+=r+"\n":e.evaluate(r)},{name:"python",prompt:">>> ",onExit:function(){e.destroy()}})});break;case"adduser":(function(){var t,n,r=s.history();r.disable(),s.push(function(i){t?(n=i,s.set_mask(!1).pop(),e.add_user(s.token(),t,n)(function(){r.enable()})):(t=i,s.set_mask(!0).set_prompt("password: "))},{prompt:"name: "})})();break;case"micro":var d=$("#micro").micro({height:$(window).height()}).show();f.args.length>=1&&e.file(s.token(),f.args[0])(function(e){d.micro("set",e)});break;case"vi":o();break;default:l()}}},{greetings:t?null:s(),prompt:t?function(e){var t;a&&a.server?t=a.server:t="unknown";var n;if(a&&u){var i=$.terminal.escape_regex(a.home);n=u.replace(new RegExp("^"+i),"~")}else n=u;e(r($.terminal.active().login_name(),t,n))}:"> ",onBeforeLogin:function(e){e.echo(s())},historyFilter:function(e){return!e.match(/^ /)},outputLimit:200,tabcompletion:!0,onInit:function(n){n.on("click",".jargon",function(){n.exec("jargon "+$(this).data("text").replace(/\s/g," "))}).on("click",".exec",function(){n.exec($(this).data("text"))}).on("click",".exception a",function(){var e=$(this).attr("href"),t=/(.*):([0-9]+):([0-9]+)$/;m=e.match(t);if(m)return $.get(m[1],function(e){var t=location.href.replace(/[^\/]+$/,""),r=m[1].replace(t,"");n.echo("[[b;white;]"+r+"]");var i=e.split("\n"),s=+m[2]-1;n.echo(i.slice(s-2,s+3).map(function(e,t){return t==2&&(e="[[;#f00;]"+e+"]"),"["+(s+t)+"]: "+e}).join("\n"))},"text"),!1});if(!t){var r={},i=[{name:"password",text:"Type your root password",prompt:"password: ",mask:!0},{name:"server",text:"Type your server name",prompt:"name: "}];n.echo("You are running Bush for the first time. You need to configure it\n"),n.history().disable(),function o(e,t){var s=i[e];s?(n.echo(s.text).push(function(i){n.pop(),s.mask&&n.set_mask(!1),r[s.name]=i,o(e+1,t)},{prompt:s.prompt}),s.mask&&n.set_mask(!0)):t()}(0,function(){n.pause(),e.configure(r)(function(){n.resume().echo("Your instalation is complete now you can refresh the page and login")})})}var s=n.token();s&&(n.pause(),e.valid_token(s)(function(t){t?e.get_settings(s)(function(t){a=t,u=a.home,e.dir(s,u)(function(e){f=e,n.resume()}),a.purgeOnUnload&&$(window).unload(function(){n.purge()})}):(l=!0,n.logout(),n.resume())}))},completion:function(e,t,n){n(["help"])},onBeforeLogout:function(t){l||e.logout(t.token())(function(){})},login:t?function(t,n,r){i=r,e.login(t,n)(function(e){r(e)})}:!1,name:"bush"}).css({overflow:"auto"});var h=$(window);h.hashchange(c).hashchange().resize(function(){var e=h.height();terminal.css("height",e-20),$("#micro").height(e)}).resize()})})});